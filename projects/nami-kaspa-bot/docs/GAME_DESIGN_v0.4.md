# 🎮 v0.4 - ATB 戰鬥系統設計

> 雙條系統 + 職業專屬大招 + 命運契合度 + 逆轉爆發

---

## 📊 屬性系統

### 命運區塊決定（隨機性）
| 屬性 | 範圍 | 說明 |
|------|------|------|
| ATK | 30-120 | 攻擊力 |
| DEF | 20-80 | 防禦力 |
| SPD | 50-150 | 敏捷 |

### Rank 固定決定
| Rank | HP |
|------|-----|
| N | 500 |
| R | 600 |
| SR | 750 |
| SSR | 1000 |

**HP = Rank 決定，ATK/DEF/SPD = 命運區塊決定**

---

## ⚡ 雙條系統

### 移動條（普通攻擊）
- 累積：**+200 / loop（固定）**
- 門檻：**1000**
- 滿了 → 普攻 → -1000

### 技能條（職業大招）
- 累積：**職業專屬屬性**
- 門檻：**1000**
- 滿了 → 大招 → -1000

| 職業 | 技能條累積 | 契合屬性 |
|------|------------|----------|
| 🧙 法師 | += ATK | 高 ATK 神卡 |
| ⚔️ 戰士 | += DEF | 高 DEF 神卡 |
| 🗡️ 盜賊 | += SPD ÷ 2 | 高 SPD 神卡 |
| 🏹 弓箭手 | += SPD | 高 SPD 神卡 |

---

## ⚔️ 職業大招

| 職業 | 大招 | 效果 |
|------|------|------|
| 🧙 法師 | **流星雨** | ATK × 5 傷害 |
| ⚔️ 戰士 | **衝擊之暈** | 對手移動條 **-500** |
| 🗡️ 盜賊 | **幻影** | 閃避下一次攻擊 |
| 🏹 弓箭手 | **穿透射擊** | ATK × 3 傷害 + 對手移動條 **-200** |

---

## 🔥 爆發模式（Rage Mode）

```
當 HP < 20% 時：
  技能條累積 x2 ！
```

**逆轉翻盤的機會！**
- 殘血法師：大招充能加倍 → 最後一發流星雨
- 殘血盜賊：閃避頻率加倍 → 苟住反殺
- 殘血戰士：暈眩頻率加倍 → 控到對手崩潰

---

## ⏰ 平手機制

```
Loop 達到 100 還沒分勝負：
  → 平手！
  → 雙方都不死
  → 10 mana 被大地之樹沒收
  → 沒有勝者獎勵
```

**大地之樹的收割：**
- 打贏：勝者拿 1-5 mana
- 打輸：敗者死（或保護免死）
- 平手：**大地之樹獨贏** 🌲

---

## 🎲 命運契合度

**完美契合 = 神卡**
```
🗡️ 盜賊 + 高SPD = 閃避狂魔
🧙 法師 + 高ATK = 大招機關槍
⚔️ 戰士 + 高DEF = 控場之王
🏹 弓手 + 高SPD = 箭雨傾盆
```

**不契合 = 殘缺卡**
```
🗡️ 盜賊 + 低SPD = 閃避慢，白給
🧙 法師 + 低ATK = 大招慢又不痛
```

**SSR 也可能輸 R！**

---

## 🔄 戰鬥核心邏輯

```python
def atb_battle(p1, p2, max_loops=100):
    p1_hp, p2_hp = p1.hp, p2.hp
    p1_move, p1_skill = 0, 0
    p2_move, p2_skill = 0, 0
    p1_evading, p2_evading = False, False
    logs = []
    
    for loop in range(max_loops):
        # 移動條固定累積
        p1_move += 200
        p2_move += 200
        
        # 技能條職業累積（爆發模式 x2）
        p1_mult = 2 if p1_hp < p1.hp * 0.2 else 1
        p2_mult = 2 if p2_hp < p2.hp * 0.2 else 1
        p1_skill += get_skill_gain(p1) * p1_mult
        p2_skill += get_skill_gain(p2) * p2_mult
        
        # P1 普攻
        if p1_move >= 1000:
            p1_move -= 1000
            if p2_evading:
                logs.append("💨 閃避！")
                p2_evading = False
            else:
                dmg = max(1, p1.atk - p2.def + rand(-5,5))
                p2_hp -= dmg
                logs.append(f"⚡ [{p1.name}] 攻擊！{dmg} 傷害")
        
        # P1 大招
        if p1_skill >= 1000:
            p1_skill -= 1000
            cast_ultimate(p1, p2, logs)
        
        # 檢查死亡
        if p2_hp <= 0:
            return {"winner": p1, "logs": logs}
        
        # P2 同理...
        
    # 100 loop 沒結果 = 平手
    return {"winner": None, "logs": logs, "draw": True}
```

---

## 📜 傷害公式

### 普通攻擊
```python
damage = max(1, attacker.atk - defender.def + random(-5, 5))
```

### 法師流星雨
```python
damage = attacker.atk * 5
```

### 弓箭手穿透射擊
```python
damage = attacker.atk * 3
defender.move_gauge = max(0, defender.move_gauge - 200)
```

---

## 📊 戰報範例

```
⚔️ ATB 決鬥開始！
══════════════════════════════════

🔵 偷偷殺你 (🗡️盜賊 R)
   HP:600 | ATK:45 DEF:35 SPD:130
   
🔴 大魔王 (🧙法師 SSR)  
   HP:1000 | ATK:95 DEF:40 SPD:70

══════════════════════════════════

⚡ [偷偷殺你] 攻擊！12 傷害 (敵HP:988)
⚡ [大魔王] 攻擊！53 傷害 (我HP:547)
🗡️ [偷偷殺你]【幻影】準備閃避！
⚡ [偷偷殺你] 攻擊！8 傷害 (敵HP:980)
⚡ [大魔王] 攻擊！💨 被閃避！
🧙 [大魔王]【流星雨】！💨 被閃避！！
⚡ [偷偷殺你] 攻擊！15 傷害 (敵HP:965)
⚡ [大魔王] 攻擊！48 傷害 (我HP:499)
🗡️ [偷偷殺你]【幻影】
...

🔥 [偷偷殺你] HP < 20%！爆發模式！
🗡️ [偷偷殺你]【幻影】（爆發加速！）
⚡ [大魔王] 攻擊！💨 閃避！
🗡️ [偷偷殺你]【幻影】
🧙 [大魔王]【流星雨】！💨 又閃避！！
⚡ [偷偷殺你] 攻擊！14 傷害 (敵HP:0)

══════════════════════════════════
🏆 勝者：偷偷殺你 (剩餘 HP: 87)
📊 Loop: 67 | 閃避: 8 | 大招: 12
🎭 R 盜賊靠高敏捷 + 爆發模式反殺 SSR 法師！
```

---

## 🔗 鏈上機制（完全繼承 v0.3）

- ✅ 命運區塊：決定職業 + Rank + ATK/DEF/SPD
- ✅ 出生銘文：記錄所有屬性
- ✅ 死亡銘文：大地之樹簽發
- ✅ 保護機制：敗者有保護則不死
- ✅ 勝者獎勵：1-5 mana
- ✅ 排隊機制：一次服務一人

---

## 📝 開發計劃

### Phase 1: 戰鬥引擎
- [ ] `atb_battle()` 核心函數
- [ ] 雙條系統實作
- [ ] 四職業大招
- [ ] 爆發模式
- [ ] 平手判定

### Phase 2: 屬性調整
- [ ] HP 改為 Rank 決定
- [ ] 舊卡 HP 補算
- [ ] 戰報格式美化

### Phase 3: 測試
- [ ] 單元測試
- [ ] 平衡性測試
- [ ] 職業對戰測試

### Phase 4: 上線
- [ ] v0.4 發布
- [ ] 公告更新

---

## 💡 未來擴展 (v0.5+)

- 暴擊系統
- 職業被動技能
- 裝備系統
- 元素相剋
- PvE 副本

---

*Created: 2026-02-08 01:49*
*Author: Nami 🌊 + Ryan*
*設計理念：命運決定一切，但逆轉永遠存在*
